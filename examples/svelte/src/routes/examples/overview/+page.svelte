<script lang="ts">
	import {
		SvelteFlow,
		Controls,
		Background,
		BackgroundVariant,
		MiniMap,
		Panel,
		SelectionMode,
		type NodeTypes,
		type EdgeTypes,
		ConnectionMode,
		ControlButton,
		type FitViewOptions,
		type Node
	} from '@xyflow/svelte';

	import CustomNode from './CustomNode.svelte';
	import CustomNodeDragHandle from './CustomNodeDragHandle.svelte';
	import CustomEdge from './CustomEdge.svelte';

	import '@xyflow/svelte/dist/style.css';
	import InitTracker from './InitTracker.svelte';

	let snap = $state(true);

	const nodeTypes: NodeTypes = {
		custom: CustomNode,
		dragHandle: CustomNodeDragHandle
	};

	const edgeTypes: EdgeTypes = {
		custom: CustomEdge
	};

	const fitViewOptions: FitViewOptions = {
		padding: 0.2,
		nodes: [{ id: '1' }, { id: '2' }]
	};

	let edges = $state([
		{
			id: '1-2',
			type: 'default',
			source: '1',
			target: '2',
			label: 'Edge Text'
		},
		{
			id: '1-3',
			type: 'smoothstep',
			source: '1',
			target: '3',
			selectable: false
		},
		{
			id: '2-4',
			type: 'custom',
			source: '2',
			target: '4',
			animated: true
		}
	]);

	let nodes: Node[] = $state([
		{
			id: '1',
			type: 'input',
			data: { label: 'Input Node' },
			position: { x: 150, y: 5 }
		},
		{
			id: '2',
			type: 'default',
			data: { label: 'Node' },
			position: { x: 0, y: 150 },
			selectable: false
		},
		{
			id: 'A',
			type: 'default',
			data: { label: 'Styled with class' },
			class: 'custom-style',
			position: { x: 150, y: 150 }
		},
		{
			id: 'D',
			type: 'default',
			data: { label: 'Not draggable' },
			position: { x: 150, y: 200 },
			draggable: false
		},
		{
			id: '3',
			type: 'output',
			data: { label: 'Output Node' },
			position: { x: 300, y: 150 }
		},
		{
			id: 'B',
			type: 'default',
			data: { label: 'Styled with style' },
			style: 'border: 2px solid #ff5050;',
			position: { x: 450, y: 150 }
		},
		{
			id: 'C',
			type: 'dragHandle',
			data: { label: 'custom drag handle' },
			dragHandle: '.custom-drag-handle',
			position: { x: 450, y: 250 }
		},
		{
			id: '4',
			type: 'custom',
			data: { label: 'Custom Node' },
			position: { x: 150, y: 300 }
		},
		{
			id: 'hideunhide',
			data: { label: 'HIDE ME' },
			position: { x: 300, y: 75 },
			hidden: true
		}
	]);

	console.log(nodes);
	function updateNode() {
		nodes[0].position.x += 20;
	}

	function updateEdge() {
		edges[0].type = edges[0].type === 'default' ? 'smoothstep' : 'default';
	}

	$effect(() => {
		console.log('nodes', nodes[0].selected);
		// console.log('edges', edges);
	});
</script>

<div class="svelte-flow">
	<SvelteFlow
		bind:nodes
		bind:edges
		{nodeTypes}
		{edgeTypes}
		class="svelte-flow"
		fitView
		fitViewOptions={{
			padding: 0.1,
			nodes: [{ id: '1' }, { id: '2' }, { id: '3' }]
		}}
		minZoom={0}
		maxZoom={Infinity}
		selectionMode={SelectionMode.Full}
		initialViewport={{ x: 100, y: 100, zoom: 2 }}
		snapGrid={snap ? [25, 25] : undefined}
		oninit={() => console.log('on init')}
		onnodeclick={(event) => console.log('on node click', event)}
		onnodemouseenter={(event) => console.log('on node enter', event)}
		onnodemouseleave={(event) => console.log('on node leave', event)}
		onedgeclick={(event) => console.log('edge click', event)}
		onconnectstart={(event) => console.log('on connect start', event)}
		onconnect={(event) => console.log('on connect', event)}
		onconnectend={(event) => console.log('on connect end', event)}
		onpaneclick={(event) => console.log('on pane click', event)}
		onpanecontextmenu={({ event }) => {
			console.log('on pane contextmenu', event);
		}}
		onnodedrag={({ event }) => {
			console.log('on node drag', event);
		}}
		onnodedragstart={({ event }) => {
			console.log('on node drag start', event);
		}}
		onnodedragstop={(event) => {
			console.log('on node drag stop', event);
		}}
		onnodecontextmenu={({ event }) => {
			event.preventDefault();
			console.log('on node contextmenu', event);
		}}
		onedgecontextmenu={({ event, edge }) => {
			event.preventDefault();
			console.log('on edge contextmenu', edge);
		}}
		onselectionclick={(event) => console.log('on selection click', event)}
		onselectioncontextmenu={(event) => console.log('on selection contextmenu', event)}
		onbeforedelete={async ({ nodes, edges }) => {
			console.log('on before delete', nodes, edges);
			const deleteElements = confirm('Are you sure you want to delete the selected elements?');
			return deleteElements;
		}}
		autoPanOnConnect
		autoPanOnNodeDrag
		connectionMode={ConnectionMode.Strict}
		attributionPosition={'top-center'}
		deleteKey={['Backspace', 'd']}
		onMove={(_, viewport) => {
			console.log('on move', viewport);
		}}
		defaultEdgeOptions={{
			selectable: false
		}}
	>
		<Controls orientation="horizontal" {fitViewOptions}>
			{#snippet before()}
				<ControlButton>xy</ControlButton>
			{/snippet}
			<ControlButton aria-label="log" onclick={() => console.log('control button')}
				>log</ControlButton
			>
		</Controls>
		<Background variant={BackgroundVariant.Dots} />
		<MiniMap />
		<Panel position="top-right">
			<button onclick={updateNode}>update node pos</button>
			<button onclick={updateEdge}>update edge type</button>
			<button
				onclick={() => {
					nodes[nodes.length - 1].hidden = !nodes[nodes.length - 1].hidden;
				}}>hide/unhide</button
			>
			<button
				onclick={() => {
					snap = !snap;
				}}>toggle snapgrid</button
			>
		</Panel>

		<InitTracker />
	</SvelteFlow>
</div>

<style>
	.svelte-flow {
		display: inline;
		--background-color: #ffffdd;
		--background-pattern-color: #5050ff;

		--minimap-background-color: #f5f6f7;
		--minimap-mask-color: rgb(255, 255, 240, 0.6);

		--controls-button-background-color: #ddd;
		--controls-button-background-color-hover: #ccc;
	}
</style>
